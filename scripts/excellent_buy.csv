import pandas as pd
import os

# ---------------------------------------------------------
# Load files safely
# ---------------------------------------------------------
excellent_path = "./csv/excellent.csv"
mongodb_path = "./csv/mongodb.csv"

if not os.path.exists(excellent_path):
    print(f"‚ùå {excellent_path} not found ‚Üí skipping.")
    exit()

excellent = pd.read_csv(excellent_path)
mongodb = pd.read_csv(mongodb_path)

# ‚úÖ Ensure 'symbol' exists in excellent
if 'symbol' not in excellent.columns:
    print("‚ùå 'symbol' column missing in excellent.csv")
    exit()

# Normalize symbol
excellent['symbol'] = excellent['symbol'].str.upper()
mongodb['symbol'] = mongodb['symbol'].str.upper()
mongodb['date'] = pd.to_datetime(mongodb['date'])
mongodb = mongodb.sort_values(['symbol', 'date']).reset_index(drop=True)

results = []

print(f"üîç Processing {len(excellent)} excellent-liquidity symbols...")

for idx, row in excellent.iterrows():
    symbol = row['symbol']
    
    # Get symbol data
    sym_data = mongodb[mongodb['symbol'] == symbol].copy()
    if len(sym_data) < 5:  # need at least 5 bars
        continue

    sym_data = sym_data.sort_values('date').reset_index(drop=True)
    A = sym_data.iloc[-1]  # latest bar
    
    # ‚úÖ Full 5-bar swing logic (from your original system)
    try:
        B = sym_data.iloc[-2]
        C = sym_data.iloc[-3]
        D = sym_data.iloc[-4]
        E = sym_data.iloc[-5]
    except IndexError:
        continue

    # üîë Logic 1: A.close > B.high + descending structure
    if (
        A['close'] > B['high'] and
        B['low'] < C['low'] and
        B['high'] < C['high'] and
        C['high'] < D['high'] and
        C['low'] < D['low']
    ):
        # ‚úÖ Add system context (from your main system)
        signal = row.to_dict()
        signal.update({
            'date': A['date'].strftime('%Y-%m-%d'),
            'buy': A['close'],
            'SL': B['low'],
            'base_date': B['date'].strftime('%Y-%m-%d'),
            'logic_used': '5-bar swing (Logic 1)',
            'volume_ratio': round(A['volume'] / sym_data['volume'].tail(5).mean(), 2),
            'rsi': A.get('RSI', 50)
        })
        results.append(signal)

    # üîë Logic 2: stricter pattern
    elif (
        A['close'] > B['high'] and
        B['high'] < C['high'] and
        B['low'] > C['low'] and
        C['high'] < D['high'] and
        C['low'] < D['low'] and
        D['high'] < E['high'] and
        D['low'] < E['low']
    ):
        signal = row.to_dict()
        signal.update({
            'date': A['date'].strftime('%Y-%m-%d'),
            'buy': A['close'],
            'SL': C['low'],
            'base_date': C['date'].strftime('%Y-%m-%d'),
            'logic_used': '5-bar swing (Logic 2)',
            'volume_ratio': round(A['volume'] / sym_data['volume'].tail(5).mean(), 2),
            'rsi': A.get('RSI', 50)
        })
        results.append(signal)

# ---------------------------------------------------------
# ‚úÖ Filter: Only high-conviction signals
# ---------------------------------------------------------
final_signals = []
for sig in results:
    # ‚úÖ RSI filter (from your system)
    if sig.get('rsi', 50) > 70:  # overbought
        continue
    # ‚úÖ Volume confirmation
    if sig.get('volume_ratio', 1.0) < 0.8:
        continue
    final_signals.append(sig)

# ---------------------------------------------------------
# Save
# ---------------------------------------------------------
if final_signals:
    output_df = pd.DataFrame(final_signals)
    
    # Keep only relevant columns (extend as needed)
    cols = ['symbol', 'date', 'buy', 'SL', 'logic_used', 'volume_ratio', 'rsi', 'liquidity_rating']
    output_df = output_df[[c for c in cols if c in output_df.columns]]
    
    os.makedirs("./csv", exist_ok=True)
    os.makedirs("./output/ai_signal", exist_ok=True)
    
    output_df.to_csv("./csv/excellent_buy.csv", index=False)
    output_df.to_csv("./output/ai_signal/excellent_buy.csv", index=False)
    
    print(f"‚úÖ {len(output_df)} high-conviction signals saved.")
    print(f"   üìà Avg RSI: {output_df['rsi'].mean():.1f} | Avg Volume Ratio: {output_df['volume_ratio'].mean():.2f}")
else:
    print("‚ö†Ô∏è No high-conviction signals found.")