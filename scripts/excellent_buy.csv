import pandas as pd
import os

# ---------------------------------------------------------
# Load CSV files
# ---------------------------------------------------------
excellent = pd.read_csv("./csv/excellent.csv")
mongodb = pd.read_csv("./csv/mongodb.csv")

excellent['date'] = pd.to_datetime(excellent['date'])
mongodb['date'] = pd.to_datetime(mongodb['date'])

# Sort mongodb
mongodb = mongodb.sort_values(['symbol', 'date']).reset_index(drop=True)

results = []

# ---------------------------------------------------------
# Process each excellent row
# ---------------------------------------------------------
for idx, row in excellent.iterrows():
    sym = row['symbol']
    date = row['date']
    close_A = row['close']

    # Filter mongodb for this symbol
    df = mongodb[mongodb['symbol'] == sym].reset_index(drop=True)

    # Check if date exists
    if date not in df['date'].values:
        continue

    # Index of A
    A_index = df.index[df['date'] == date][0]

    # Need previous 2 rows: B, C
    if A_index - 1 < 0 or A_index - 2 < 0:
        continue

    A = df.loc[A_index]
    B = df.loc[A_index - 1]
    C = df.loc[A_index - 2]

    # Conditions:
    cond1 = A['close'] > B['high']
    cond2 = B['low'] >= C['low']

    if cond1 and cond2:
        results.append({
            "symbol": sym,
            "date_A": A['date'],
            "close_A": A['close'],
            "B_date": B['date'],
            "B_high": B['high'],
            "B_low": B['low'],
            "C_date": C['date'],
            "C_low": C['low'],
        })

# ---------------------------------------------------------
# Save output
# ---------------------------------------------------------
output_df = pd.DataFrame(results)

os.makedirs("./csv", exist_ok=True)
os.makedirs("./output/ai_signal", exist_ok=True)

output_df.to_csv("./csv/excellent_buy.csv", index=False)
output_df.to_csv("./output/ai_signal/excellent_buy.csv", index=False)

print("âœ… excellent_buy.csv generated successfully!")
print("Total signals:", len(output_df))