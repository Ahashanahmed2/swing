import pandas as pd
import os
from pathlib import Path
from datetime import datetime

# ফাইল পাথগুলি এবং তাদের সংক্ষিপ্ত নাম
files_info = {
    "short": "./csv/short_buy.csv",
    "gape": "./csv/gape_buy.csv", 
    "rsi": "./csv/rsi_30_buy.csv",
    "swing": "./csv/swing_buy.csv",
    "uptrend": "./output/ai_signal/uptrand.csv"
}

# আউটপুট ডিরেক্টরি ও ফাইল
output_dir = "./output/ai_signal/"
output_file = os.path.join(output_dir, "daily_buy.csv")

# আউটপুট ডিরেক্টরি তৈরি করুন (যদি না থাকে)
Path(output_dir).mkdir(parents=True, exist_ok=True)

# প্রতিটি ফাইলের জন্য সর্বশেষ তারিখের ডেটা সংরক্ষণ করার লিস্ট
latest_date_data = []

# প্রতিটি ফাইলের সর্বশেষ তারিখ ট্র্যাক রাখার জন্য
file_latest_dates = {}

# প্রতিটি ফাইল প্রসেস করুন এবং সর্বশেষ তারিখ খুঁজে বের করুন
print("Finding latest dates from all files...")
for file_key, file_path in files_info.items():
    try:
        # ফাইলটি বিদ্যমান কিনা পরীক্ষা করুন
        if not os.path.exists(file_path):
            print(f"Warning: File '{file_path}' not found. Skipping...")
            continue

        # CSV ফাইল পড়ুন
        df = pd.read_csv(file_path)

        # ফাইলে কোনো ডাটা আছে কিনা পরীক্ষা করুন
        if df.empty:
            print(f"Warning: File '{file_key}' is empty. Skipping...")
            continue

        # তারিখ কলাম খুঁজুন
        date_column = None
        date_columns = ['date', 'Date', 'DATE', 'timestamp', 'Timestamp', 'TIMESTAMP', 'p1_date', 'p2_date']

        for col in date_columns:
            if col in df.columns:
                date_column = col
                break

        if date_column is None:
            print(f"Warning: No date column found in '{file_key}'. Skipping file...")
            continue
        
        # তারিখ কলামকে datetime ফরম্যাটে কনভার্ট করুন
        try:
            df[date_column] = pd.to_datetime(df[date_column], errors='coerce')
            
            # নাল ভ্যালু রিমুভ করুন
            df = df.dropna(subset=[date_column])
            
            if df.empty:
                print(f"Warning: No valid dates in '{file_key}'. Skipping file...")
                continue
            else:
                # সর্বশেষ তারিখ খুঁজুন
                latest_date = df[date_column].max()
                file_latest_dates[file_key] = latest_date
                print(f"Info: '{file_key}' - latest date is {latest_date.date()}")
                
        except Exception as e:
            print(f"Warning: Could not parse date column in '{file_key}'. Error: {e}")
            continue

    except Exception as e:
        print(f"Error reading file '{file_path}': {str(e)}")
        continue

# যদি কোনো ফাইলে তারিখ পাওয়া যায়
if file_latest_dates:
    # সব ফাইলের সর্বশেষ তারিখগুলোর মধ্যে থেকে সবচেয়ে সাম্প্রতিক তারিখ খুঁজুন
    overall_latest_date = max(file_latest_dates.values())
    print(f"\nOverall latest date across all files: {overall_latest_date.date()}")
    
    # এখন শুধুমাত্র overall_latest_date তারিখের ডেটা সংগ্রহ করুন
    print(f"\nCollecting data only for date: {overall_latest_date.date()}")
    
    for file_key, file_path in files_info.items():
        try:
            # ফাইলটি বিদ্যমান কিনা পরীক্ষা করুন
            if not os.path.exists(file_path):
                continue

            # CSV ফাইল পড়ুন
            df = pd.read_csv(file_path)
            
            if df.empty:
                continue

            # তারিখ কলাম খুঁজুন
            date_column = None
            date_columns = ['date', 'Date', 'DATE', 'timestamp', 'Timestamp', 'TIMESTAMP', 'p1_date', 'p2_date']

            for col in date_columns:
                if col in df.columns:
                    date_column = col
                    break

            if date_column is None:
                continue
            
            # তারিখ কলামকে datetime ফরম্যাটে কনভার্ট করুন
            df[date_column] = pd.to_datetime(df[date_column], errors='coerce')
            
            # নাল ভ্যালু রিমুভ করুন
            df = df.dropna(subset=[date_column])
            
            if df.empty:
                continue
            
            # শুধুমাত্র overall_latest_date তারিখের ডাটা নিন
            latest_data = df[df[date_column] == overall_latest_date]
            
            if len(latest_data) == 0:
                # যদি এই ফাইলে overall_latest_date না থাকে, তাহলে ফাইলের নিজের সর্বশেষ তারিখের ডেটা নিন
                if file_key in file_latest_dates:
                    file_latest_date = file_latest_dates[file_key]
                    latest_data = df[df[date_column] == file_latest_date]
                    print(f"  '{file_key}': Using file's latest date {file_latest_date.date()} (not matching overall latest)")
                else:
                    continue
            else:
                print(f"  '{file_key}': Found {len(latest_data)} symbols for overall latest date")
            
            # প্রতিটি সারির জন্য প্রসেস করুন
            for index, row in latest_data.iterrows():
                symbol = None

                # 'symbol' কলাম আছে কিনা পরীক্ষা করুন
                if 'symbol' in df.columns:
                    symbol = str(row['symbol'])
                else:
                    # সাধারণ কলাম নামগুলি পরীক্ষা করুন
                    common_symbol_columns = ['SYMBOL', 'Symbol', 'Ticker', 'ticker', 'name', 'Name']

                    for col in common_symbol_columns:
                        if col in df.columns:
                            symbol = str(row[col])
                            break

                if symbol:
                    # সারির ডাটা কপি করুন
                    row_data = row.to_dict()

                    # symbol কলাম যোগ করুন (যদি আগে থেকে না থাকে)
                    if 'symbol' not in row_data:
                        row_data['symbol'] = symbol

                    # 'file' কলাম যোগ করুন
                    row_data['file'] = file_key
                    
                    # তারিখ যোগ করুন
                    row_data['latest_date'] = overall_latest_date.date()

                    # লিস্টে যোগ করুন
                    latest_date_data.append(row_data)

        except Exception as e:
            print(f"Error processing file '{file_path}' for latest date: {str(e)}")
            continue
    
    # যদি কোনো ডাটা পাওয়া যায়
    if latest_date_data:
        # লিস্ট থেকে DataFrame তৈরি করুন
        result_df = pd.DataFrame(latest_date_data)
        
        # 1. NO নামের সকল কলাম বাতিল করুন
        no_columns = [col for col in result_df.columns if col.upper() == 'NO']
        if no_columns:
            print(f"\nRemoving 'NO' columns: {no_columns}")
            result_df = result_df.drop(columns=no_columns)
        
        # 2. close কলাম থাকলে তার value buy কলামে রাখুন এবং close কলাম বাতিল করুন
        close_columns = [col for col in result_df.columns if col.lower() == 'close']
        if close_columns:
            print(f"\nProcessing 'close' columns: {close_columns}")
            
            # প্রতিটি close কলামের জন্য
            for close_col in close_columns:
                # যদি buy কলাম না থাকে, তাহলে নতুন create করুন
                if 'buy' not in result_df.columns:
                    result_df['buy'] = result_df[close_col]
                else:
                    # buy কলাম আছে, তাহলে close কলামের মান দিয়ে update করুন
                    # শুধুমাত্র যেখানে buy কলামে ভ্যালু নেই বা নাল আছে
                    mask = result_df['buy'].isna() | (result_df['buy'] == '')
                    result_df.loc[mask, 'buy'] = result_df.loc[mask, close_col]
                
                # close কলাম বাতিল করুন
                result_df = result_df.drop(columns=[close_col])
                print(f"  Moved values from '{close_col}' to 'buy' column and removed '{close_col}'")

        # 'symbol' এবং 'file' কলাম নিশ্চিত করুন
        if 'symbol' not in result_df.columns:
            print("Error: 'symbol' column not found in any data.")

        if 'file' not in result_df.columns:
            print("Error: 'file' column was not created.")

        # কলামগুলির ক্রম ঠিক করুন
        ordered_columns = []
        
        # প্রথমে symbol এবং file রাখুন
        preferred_order = ['symbol', 'file', 'buy', 'latest_date']
        for col in preferred_order:
            if col in result_df.columns and col not in ordered_columns:
                ordered_columns.append(col)
        
        # বাকি কলাম যোগ করুন
        for col in result_df.columns:
            if col not in ordered_columns:
                ordered_columns.append(col)

        result_df = result_df[ordered_columns]

        # ডুপ্লিকেট সিম্বল রিমুভ করুন (একই সিম্বল একাধিক ফাইলে থাকলে)
        result_df = result_df.drop_duplicates(subset=['symbol'], keep='first')

        # ফলাফল CSV হিসেবে সংরক্ষণ করুন
        result_df.to_csv(output_file, index=False)

        print(f"\n{'='*50}")
        print(f"Successfully saved {len(result_df)} unique symbols to '{output_file}'")
        print(f"All symbols are from latest date: {overall_latest_date.date()}")
        print(f"Columns in output file: {list(result_df.columns)}")

        # সোর্স ফাইলের সংখ্যা দেখান
        print("\nSymbols count by source file:")
        file_counts = result_df['file'].value_counts()
        for file_key, count in file_counts.items():
            print(f"{file_key}: {count} symbols")

        # প্রথম কিছু সিম্বল দেখান
        print(f"\nFirst 10 symbols in output (all from {overall_latest_date.date()}):")
        for i, (_, row) in enumerate(result_df.head(10).iterrows()):
            buy_price = row.get('buy', 'N/A')
            print(f"  {i+1}. {row['symbol']} ({row['file']}) - Buy: {buy_price}")

        # সিম্বল লিস্ট ফাইল হিসেবে সংরক্ষণ করুন
        symbols_file = os.path.join(output_dir, "daily_symbols.txt")
        with open(symbols_file, 'w') as f:
            for symbol in result_df['symbol'].tolist():
                f.write(f"{symbol}\n")
        print(f"\nSymbol list saved to: {symbols_file}")

    else:
        print(f"\nNo data found for the latest date {overall_latest_date.date()} in any file.")
        
else:
    print("No valid date information found in any input file.")

# অপশনাল: ফলাফল দেখান
if os.path.exists(output_file):
    result = pd.read_csv(output_file)
    print(f"\n{'='*50}")
    print("Summary of generated daily_buy.csv:")
    print(f"Total symbols: {len(result)}")
    print(f"All from date: {overall_latest_date.date() if 'overall_latest_date' in locals() else 'N/A'}")
    print(f"Sources: {', '.join(result['file'].unique())}")
    
    # buy কলামের স্যাম্পল ভ্যালু দেখান
    if 'buy' in result.columns:
        print(f"Buy column sample values:")
        non_null_buy = result['buy'].dropna()
        if len(non_null_buy) > 0:
            for i, val in enumerate(non_null_buy.head(5)):
                print(f"  {i+1}. {val}")