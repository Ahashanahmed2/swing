import pandas as pd
import os
from pathlib import Path
from datetime import datetime

# ফাইল পাথগুলি এবং তাদের সংক্ষিপ্ত নাম
files_info = {
    "short": "./csv/short_buy.csv",
    "gape": "./csv/gape_buy.csv", 
    "rsi": "./csv/rsi_30_buy.csv",
    "swing": "./csv/swing_buy.csv",
    "uptrend": "./csv/uptrand .csv"  # স্পেস আছে ফাইলনেমে
}

# আউটপুট ডিরেক্টরি ও ফাইল
output_dir = "./output/ai_signal/"
output_file = os.path.join(output_dir, "daily_buy.csv")

# আউটপুট ডিরেক্টরি তৈরি করুন (যদি না থাকে)
Path(output_dir).mkdir(parents=True, exist_ok=True)

# সব সিম্বল সংরক্ষণ করার জন্য লিস্ট
all_data = []

# প্রতিটি ফাইল প্রসেস করুন
for file_key, file_path in files_info.items():
    try:
        # ফাইলটি বিদ্যমান কিনা পরীক্ষা করুন
        if not os.path.exists(file_path):
            print(f"Warning: File '{file_path}' not found. Skipping...")
            continue
        
        # CSV ফাইল পড়ুন
        df = pd.read_csv(file_path)
        
        # ফাইলে কোনো ডাটা আছে কিনা পরীক্ষা করুন
        if df.empty:
            print(f"Warning: File '{file_key}' is empty. Skipping...")
            continue
        
        # তারিখ কলাম খুঁজুন
        date_column = None
        date_columns = ['date', 'Date', 'DATE', 'timestamp', 'Timestamp', 'TIMESTAMP', 'p1_date', 'p2_date']
        
        for col in date_columns:
            if col in df.columns:
                date_column = col
                break
        
        if date_column is None:
            print(f"Warning: No date column found in '{file_key}'. Using all data.")
            latest_data = df
        else:
            # তারিখ কলামকে datetime ফরম্যাটে কনভার্ট করুন
            try:
                df[date_column] = pd.to_datetime(df[date_column])
                # সর্বশেষ তারিখ খুঁজুন
                latest_date = df[date_column].max()
                # শুধুমাত্র সর্বশেষ তারিখের ডাটা নিন
                latest_data = df[df[date_column] == latest_date]
                print(f"Info: For '{file_key}', latest date is {latest_date.date()}, found {len(latest_data)} symbols")
            except Exception as e:
                print(f"Warning: Could not parse date column in '{file_key}'. Using all data. Error: {e}")
                latest_data = df
        
        # প্রতিটি সারির জন্য প্রসেস করুন
        for index, row in latest_data.iterrows():
            symbol = None
            
            # 'symbol' কলাম আছে কিনা পরীক্ষা করুন
            if 'symbol' in df.columns:
                symbol = str(row['symbol'])
            else:
                # সাধারণ কলাম নামগুলি পরীক্ষা করুন
                common_symbol_columns = ['SYMBOL', 'Symbol', 'Ticker', 'ticker', 'name', 'Name']
                
                for col in common_symbol_columns:
                    if col in df.columns:
                        symbol = str(row[col])
                        break
            
            if symbol:
                # সারির ডাটা কপি করুন
                row_data = row.to_dict()
                
                # symbol কলাম যোগ করুন (যদি আগে থেকে না থাকে)
                if 'symbol' not in row_data:
                    row_data['symbol'] = symbol
                
                # 'file' কলাম যোগ করুন
                row_data['file'] = file_key
                
                # লিস্টে যোগ করুন
                all_data.append(row_data)
    
    except Exception as e:
        print(f"Error processing file '{file_path}': {str(e)}")
        continue

# যদি কোনো ডাটা পাওয়া যায়
if all_data:
    # লিস্ট থেকে DataFrame তৈরি করুন
    result_df = pd.DataFrame(all_data)
    
    # 'symbol' এবং 'file' কলাম নিশ্চিত করুন
    if 'symbol' not in result_df.columns:
        print("Error: 'symbol' column not found in any data.")
    
    if 'file' not in result_df.columns:
        print("Error: 'file' column was not created.")
    
    # কলামগুলির ক্রম ঠিক করুন (symbol প্রথমে, তারপর file, তারপর বাকি কলাম)
    # প্রথমে symbol এবং file বের করুন
    ordered_columns = []
    if 'symbol' in result_df.columns:
        ordered_columns.append('symbol')
    if 'file' in result_df.columns:
        ordered_columns.append('file')
    
    # বাকি কলাম যোগ করুন (যেগুলো ইতিমধ্যে যোগ করা হয়নি)
    for col in result_df.columns:
        if col not in ordered_columns:
            ordered_columns.append(col)
    
    result_df = result_df[ordered_columns]
    
    # ডুপ্লিকেট সিম্বল রিমুভ করুন (একই সিম্বল একাধিক ফাইলে থাকলে)
    # একই সিম্বলের জন্য শুধু প্রথমটি রাখুন
    result_df = result_df.drop_duplicates(subset=['symbol'], keep='first')
    
    # ফলাফল CSV হিসেবে সংরক্ষণ করুন
    result_df.to_csv(output_file, index=False)
    
    print(f"\n{'='*50}")
    print(f"Successfully saved {len(result_df)} unique symbols to '{output_file}'")
    print(f"Columns in output file: {list(result_df.columns)}")
    
    # সোর্স ফাইলের সংখ্যা দেখান
    print("\nSymbols count by source file:")
    file_counts = result_df['file'].value_counts()
    for file_key, count in file_counts.items():
        print(f"{file_key}: {count} symbols")
    
    # তারিখের তথ্য দেখান
    print("\nDate information:")
    date_columns_in_result = [col for col in result_df.columns if 'date' in col.lower() or 'Date' in col]
    for date_col in date_columns_in_result:
        if date_col in result_df.columns:
            unique_dates = result_df[date_col].dropna().unique()
            print(f"{date_col}: {len(unique_dates)} unique dates")
            if len(unique_dates) > 0:
                print(f"  Latest: {pd.to_datetime(unique_dates).max()}")
    
    # প্রথম কিছু সিম্বল দেখান
    print(f"\nFirst 10 symbols in output:")
    for i, (_, row) in enumerate(result_df.head(10).iterrows()):
        print(f"  {i+1}. {row['symbol']} ({row['file']})")
    
    # সিম্বল লিস্ট ফাইল হিসেবে সংরক্ষণ করুন
    symbols_file = os.path.join(output_dir, "daily_symbols.txt")
    with open(symbols_file, 'w') as f:
        for symbol in result_df['symbol'].tolist():
            f.write(f"{symbol}\n")
    print(f"\nSymbol list saved to: {symbols_file}")
    
else:
    print("No data found in any of the input files.")

# অপশনাল: ফলাফল দেখান
if os.path.exists(output_file):
    result = pd.read_csv(output_file)
    print(f"\n{'='*50}")
    print("Summary of generated daily_buy.csv:")
    print(f"Total symbols: {len(result)}")
    print(f"Sources: {', '.join(result['file'].unique())}")
    
    # file কলামের মান দেখান
    print(f"\nUnique values in 'file' column: {result['file'].unique().tolist()}")