import pandas as pd
import os
from pathlib import Path

# ফাইল পাথগুলি এবং তাদের সংক্ষিপ্ত নাম
files_info = {
    "short": "./csv/short_buy.csv",
    "gape": "./csv/gape_buy.csv", 
    "rsi": "./csv/rsi_30_buy.csv",
    "swing": "./csv/swing_buy.csv",
    "uptrend": "./csv/uptrand.csv"  # স্পেস আছে ফাইলনেমে
}

# আউটপুট ডিরেক্টরি ও ফাইল
output_dir = "./output/ai_signal/"
output_file = os.path.join(output_dir, "daily_buy.csv")

# আউটপুট ডিরেক্টরি তৈরি করুন (যদি না থাকে)
Path(output_dir).mkdir(parents=True, exist_ok=True)

# সব সিম্বল সংরক্ষণ করার জন্য লিস্ট
all_data = []

# প্রতিটি ফাইল প্রসেস করুন
for file_key, file_path in files_info.items():
    try:
        # ফাইলটি বিদ্যমান কিনা পরীক্ষা করুন
        if not os.path.exists(file_path):
            print(f"Warning: File '{file_path}' not found. Skipping...")
            continue
        
        # CSV ফাইল পড়ুন
        df = pd.read_csv(file_path)
        
        # ফাইলে কোনো ডাটা আছে কিনা পরীক্ষা করুন
        if df.empty:
            print(f"Warning: File '{file_key}' is empty. Skipping...")
            continue
        
        # প্রতিটি সারির জন্য প্রসেস করুন
        for index, row in df.iterrows():
            symbol = None
            
            # 'symbol' কলাম আছে কিনা পরীক্ষা করুন
            if 'symbol' in df.columns:
                symbol = str(row['symbol'])
            else:
                # সাধারণ কলাম নামগুলি পরীক্ষা করুন
                common_symbol_columns = ['SYMBOL', 'Symbol', 'Ticker', 'ticker', 'name', 'Name']
                
                for col in common_symbol_columns:
                    if col in df.columns:
                        symbol = str(row[col])
                        # কলাম নাম 'symbol' এ পরিবর্তন করুন
                        df = df.rename(columns={col: 'symbol'})
                        break
            
            if symbol:
                # সারির ডাটা কপি করুন
                row_data = row.to_dict()
                
                # symbol কলাম যোগ করুন (যদি আগে থেকে না থাকে)
                if 'symbol' not in row_data:
                    row_data['symbol'] = symbol
                
                # 'file' কলাম যোগ করুন
                row_data['file'] = file_key
                
                # লিস্টে যোগ করুন
                all_data.append(row_data)
    
    except Exception as e:
        print(f"Error processing file '{file_path}': {str(e)}")
        continue

# যদি কোনো ডাটা পাওয়া যায়
if all_data:
    # লিস্ট থেকে DataFrame তৈরি করুন
    result_df = pd.DataFrame(all_data)
    
    # 'symbol' এবং 'file' কলাম নিশ্চিত করুন
    if 'symbol' not in result_df.columns:
        print("Error: 'symbol' column not found in any data.")
    
    if 'file' not in result_df.columns:
        print("Error: 'file' column was not created.")
    
    # কলামগুলির ক্রম ঠিক করুন (symbol প্রথমে, তারপর file, তারপর বাকি কলাম)
    # প্রথমে symbol এবং file বের করুন
    ordered_columns = []
    if 'symbol' in result_df.columns:
        ordered_columns.append('symbol')
    if 'file' in result_df.columns:
        ordered_columns.append('file')
    
    # বাকি কলাম যোগ করুন (যেগুলো ইতিমধ্যে যোগ করা হয়নি)
    for col in result_df.columns:
        if col not in ordered_columns:
            ordered_columns.append(col)
    
    result_df = result_df[ordered_columns]
    
    # ফলাফল CSV হিসেবে সংরক্ষণ করুন
    result_df.to_csv(output_file, index=False)
    
    print(f"Successfully saved {len(result_df)} rows to '{output_file}'")
    print(f"Total unique symbols: {result_df['symbol'].nunique()}")
    print(f"Columns in output file: {list(result_df.columns)}")
    
    # সোর্স ফাইলের সংখ্যা দেখান
    print("\nData count by source file:")
    file_counts = result_df['file'].value_counts()
    for file_key, count in file_counts.items():
        print(f"{file_key}: {count} rows")
    
    # একাধিক ফাইলে থাকা সিম্বল দেখান
    symbol_counts = result_df['symbol'].value_counts()
    multi_symbols = symbol_counts[symbol_counts > 1]
    if not multi_symbols.empty:
        print(f"\nSymbols appearing in multiple files: {len(multi_symbols)}")
        for symbol, count in multi_symbols.head().iteritems():
            files = result_df[result_df['symbol'] == symbol]['file'].unique()
            print(f"  {symbol}: {count} times (files: {', '.join(files)})")
else:
    print("No data found in any of the input files.")

# অপশনাল: ফলাফল দেখান
if os.path.exists(output_file):
    result = pd.read_csv(output_file)
    print("\nFirst few rows of the generated file:")
    print(result.head())
    
    print("\nSample of data structure:")
    print(f"Total rows: {len(result)}")
    print(f"Total columns: {len(result.columns)}")
    
    # file কলামের মান দেখান
    print(f"\nUnique values in 'file' column: {result['file'].unique().tolist()}")